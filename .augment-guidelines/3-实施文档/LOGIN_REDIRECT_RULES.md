# FDX SMART WORK 2.0 登录后重定向规则详细说明

## 📋 重定向规则概述

FDX SMART WORK 2.0项目实现了**完全基于数据库驱动的智能重定向系统**，通过"用户资料"表和"工作页面"表的关联，确保不同职位的用户登录后能够**单次、直接、准确**地重定向到其对应的工作页面。

**🎉 最新优化 (2025-06-29)**:
- ✅ **消除双重重定向问题**：用户登录后只执行一次重定向，无页面闪烁
- ✅ **移除角色映射兜底机制**：完全基于数据库配置，提高重定向准确性
- ✅ **统一重定向逻辑**：所有重定向由根页面统一处理，确保数据一致性
- ✅ **增强调试能力**：详细的日志输出，便于问题排查和系统监控

## 🎯 核心重定向逻辑

### 1. **优化后的数据库驱动重定向机制**

**重定向流程** (单次执行):
1. **用户登录** → 根据登录账号在"用户资料"表中查找用户信息
2. **保存用户上下文** → 将完整用户信息（包括工作页面）保存到用户上下文
3. **重定向到根页面** → 登录表单重定向到根页面，由根页面统一处理重定向逻辑
4. **获取工作页面名称** → 从用户上下文的"工作页面"字段获取页面名称
5. **查找对应路由** → 在"工作页面"表中根据页面名称查找对应的"页面路由"
6. **执行单次重定向** → 使用找到的路由进行页面重定向，避免重复执行

### 2. **数据库表结构关系**

#### 用户资料表 (`用户资料`)
```sql
SELECT 账号, 姓名, 职称, 工作页面 FROM "用户资料";
```

#### 工作页面表 (`工作页面`)
```sql
SELECT 页面名称, 页面路由 FROM "工作页面";
```

**完整映射关系表** (基于实际数据库配置):
| 职称 | 工作页面名称 | 页面路由 | 页面功能 | 用户示例 |
|------|-------------|----------|----------|----------|
| 总指挥 | 总指挥工作台 | `/boss` | 总指挥管理和决策支持系统 | 慕容秋水(bos001) |
| 经理 | 管理员工作台 | `/manager` | 部门管理和流程监控系统 | 叶孤城(man001) |
| 师傅 | 球磨车间记录 | `/ball-mill-workshop` | 球磨机操作和监控工作台 | 李寻欢(bal001) |
| 师傅 | 压滤车间记录 | `/filter-press-workshop` | 压滤机操作和数据管理工作台 | 花满楼(fil001) |
| 化验师 | 实验室工作台 | `/lab` | 实验室检测和数据分析 | 楚留香(lab001) |
| 师傅 | 生产控制中心 | `/production-control` | 生产流程控制和数据监控 | 陆小凤(con001) |
| 机修组 | 采购申请系统 | `/purchase-request` | 采购申请和需求管理 | 修宏涛 |
| 组长 | 采购管理系统 | `/purchase-management` | 采购订单和供应商管理 | (待分配) |

**⚠️ 重要说明**: 重定向完全基于"工作页面"字段，而非"职称"字段。相同职称的用户可能被分配到不同的工作页面。

### 3. **优化后的重定向架构**

#### 重定向处理分工：
1. **登录表单** (`src/components/login-form.tsx`): 负责用户认证和用户上下文保存
2. **根页面** (`src/app/page.tsx`): 负责统一的重定向逻辑处理
3. **工作页面工具** (`src/lib/work-page-utils.ts`): 负责数据库查询和路由映射

#### 优化后的实现逻辑：

```typescript
// 登录表单: 只负责认证和保存用户信息
if (result.user) {
  // 保存完整用户信息到上下文（包括工作页面字段）
  login(result.user, rememberMe);
  // 重定向到根页面，由根页面处理智能重定向
  router.push('/');
}

// 根页面: 统一处理重定向逻辑
useEffect(() => {
  if (isAuthenticated && user && !hasRedirected.current) {
    hasRedirected.current = true; // 防止重复重定向
    const redirectRoute = await getSmartRedirectRoute(user);
    router.replace(redirectRoute);
  }
}, [isAuthenticated, user, isLoading, router]);

// 智能重定向函数: 完全基于数据库驱动
export async function getSmartRedirectRoute(user: any): Promise<string> {
  const workPageName = user.工作页面 || user.workPage;
  if (workPageName && workPageName !== 'demo') {
    return await getUserRedirectRoute(user);
  }
  return '/lab'; // 最终兜底
}
```

## 🔄 重定向场景分析

### 场景1: 直接访问根路径 `/` (优化后)
- **未登录用户**: `/` → `/auth/login`
- **已登录用户**: `/` → 根据数据库工作页面映射重定向到工作页面 (单次重定向)

### 场景2: 访问受保护页面
- **未登录用户**: `/protected-page` → `/auth/login?redirect=/protected-page`
- **登录成功后**: 自动返回 `/protected-page`

### 场景3: 已登录用户访问登录页
- **任何已登录用户**: `/auth/login` → 立即重定向到工作页面

### 场景4: 登录成功后的重定向 (优化后)
- **统一流程**: 登录成功 → 保存用户上下文 → 重定向到根页面 → 根页面执行智能重定向
- **单次重定向**: 使用 `hasRedirected.current` 防止重复重定向
- **数据一致性**: 重定向基于用户上下文中的完整用户信息

### 场景5: 新增 - 重定向状态管理
- **防重复机制**: 使用 `useRef` 标记重定向状态，避免多次执行
- **加载状态检查**: 等待用户上下文加载完成后再执行重定向
- **错误恢复**: 重定向异常时自动使用兜底路由 `/lab`

## 👥 用户职位与工作页面详细映射

### 总指挥职位
- **工作页面名称**: 总指挥工作台
- **页面路由**: `/boss`
- **权限级别**: 最高
- **功能范围**: 全局管理、数据监控、决策支持
- **用户示例**: 蒋荷、王兴国、陈文学、陈鴅、慕容秋水

### 管理员职位
- **工作页面名称**: 管理员工作台
- **页面路由**: `/manager`
- **权限级别**: 高级
- **功能范围**: 部门管理、流程监控、数据分析
- **用户示例**: 西门吹雪

### 球磨工职位
- **工作页面名称**: 球磨车间记录
- **页面路由**: `/ball-mill-workshop`
- **权限级别**: 操作级
- **功能范围**: 球磨机操作、设备监控、生产记录
- **用户示例**: 沈金、张双燕、杨卫东、李寻欢

### 压滤工职位
- **工作页面名称**: 压滤车间记录
- **页面路由**: `/filter-press-workshop`
- **权限级别**: 操作级
- **功能范围**: 压滤机操作、数据管理、质量控制
- **用户示例**: 杨加鱼、杨宽吉、段飞艳、杨坤梅等

### 化验师职位 (已优化)
- **工作页面名称**: 实验室工作台 (已更新)
- **页面路由**: `/lab`
- **权限级别**: 技术级
- **功能范围**: 实验室检测、数据分析、质量控制
- **用户示例**: 楚留香(lab001)、余云柏等
- **⚠️ 注意**: 部分化验师可能分配到"生产控制中心"，具体以数据库配置为准

### 组长职位
- **工作页面名称**: 采购管理系统
- **页面路由**: `/purchase-management`
- **权限级别**: 管理级
- **功能范围**: 采购申请、订单管理、供应商协调
- **用户示例**: 中原一点红

## 🛡️ 认证状态管理

### 认证检查流程
1. **页面加载时**: 检查localStorage中的用户会话
2. **会话验证**: 验证token有效性和过期时间
3. **用户信息获取**: 从数据库获取最新用户信息
4. **重定向执行**: 根据认证状态和用户角色执行重定向

### 会话管理
```typescript
interface SessionInfo {
  token: string;
  loginTime: number;
  expiresAt: number;
  lastActivity: number;
}
```

## 🔧 技术实现细节

### 重定向方法选择
- **router.replace()**: 替换当前历史记录，避免用户通过后退按钮返回
- **router.push()**: 添加新的历史记录（特殊场景使用）

### 异步处理
```typescript
// 使用 setTimeout 确保状态更新完成后再重定向
setTimeout(redirectToWorkspace, 0);
```

### 错误处理
```typescript
try {
  // 重定向逻辑
} catch (error) {
  console.error('❌ [登录页面] 重定向异常:', error);
  router.replace('/lab'); // 兜底重定向
}
```

## �️ 数据库查询逻辑

### 登录时的数据库查询流程

#### 步骤1: 用户认证查询
```sql
SELECT * FROM "用户资料"
WHERE "账号" = ? AND "密码" = ?;
```

#### 步骤2: 获取工作页面路由
```sql
SELECT w."页面路由"
FROM "用户资料" u
JOIN "工作页面" w ON u."工作页面" = w."页面名称"
WHERE u."账号" = ?;
```

#### 步骤3: 兜底查询（如果JOIN失败）
```sql
SELECT "页面路由" FROM "工作页面"
WHERE "页面名称" = 'lab' OR "页面路由" = '/lab'
LIMIT 1;
```

## �📊 重定向流程图

```
用户登录 → 查询用户资料表 → 获取工作页面名称
                                    ↓
                              查询工作页面表 → 找到对应路由？
                                                ↓
                                               是 → 重定向到工作页面
                                                ↓
                                               否 → 重定向到默认页面(/lab)
```

### 完整的认证和重定向流程

```
用户访问 → 检查认证状态 → 已登录？
                                ↓
                               是 → 检查重定向参数 → 有参数？
                                                      ↓
                                                     是 → 重定向到指定页面
                                                      ↓
                                                     否 → 数据库查询工作页面
                                                           ↓
                                                         重定向到工作页面
                                ↓
                               否 → 重定向到登录页面
```

## 🎯 URL重定向参数示例

### 访问受保护页面的完整流程
1. 用户访问: `https://app.com/purchase-management`
2. 检测未登录，重定向到: `https://app.com/auth/login?redirect=/purchase-management`
3. 用户登录成功后，自动重定向到: `https://app.com/purchase-management`

### 支持的重定向参数格式
- 相对路径: `?redirect=/dashboard`
- 绝对路径: `?redirect=/admin/settings`
- 带查询参数: `?redirect=/data?filter=today`

## 🔍 调试和日志

### 控制台日志标识
- `✅ [首页]`: 根页面重定向日志
- `✅ [登录页面]`: 登录页面重定向日志
- `🎯 [登录页面]`: 重定向参数处理日志
- `🔄 [登录页面]`: 默认工作页面重定向日志
- `❌ [登录页面]`: 重定向异常日志

### 常见问题排查
1. **重定向循环**: 检查用户角色数据是否正确
2. **重定向失败**: 检查目标页面是否存在
3. **权限问题**: 验证用户是否有访问目标页面的权限

## 📝 配置说明

### 数据库配置管理
重定向映射关系完全由数据库驱动，可通过以下方式进行配置：

#### 1. 添加新的工作页面
```sql
INSERT INTO "工作页面" ("页面名称", "页面路由")
VALUES ('新工作页面', '/new-page');
```

#### 2. 更新用户的工作页面
```sql
UPDATE "用户资料"
SET "工作页面" = '新工作页面'
WHERE "职称" = '特定职位';
```

#### 3. 查看当前映射关系
```sql
SELECT
    u.职称,
    u.工作页面,
    w.页面路由,
    COUNT(*) as 用户数量
FROM "用户资料" u
LEFT JOIN "工作页面" w ON u.工作页面 = w.页面名称
GROUP BY u.职称, u.工作页面, w.页面路由
ORDER BY u.职称;
```

#### 4. 兜底机制
如果用户的工作页面在工作页面表中找不到对应路由，系统将重定向到默认页面 `/lab`。

## 📈 当前系统配置状态

### 已配置的工作页面 (截至2025-06-29)
| ID | 页面名称 | 页面路由 | 状态 |
|----|----------|----------|------|
| 9 | 球磨车间记录 | `/ball-mill-workshop` | ✅ 已配置 |
| 10 | 总指挥工作台 | `/boss` | ✅ 已配置 |
| 11 | 压滤车间记录 | `/filter-press-workshop` | ✅ 已配置 |
| 12 | 管理员工作台 | `/manager` | ✅ 已配置 |
| 13 | 生产控制中心 | `/production-control` | ✅ 已配置 |
| 14 | 采购管理系统 | `/purchase-management` | ✅ 已配置 |
| 15 | 采购申请系统 | `/purchase-request` | ✅ 已配置 |

### 用户分布统计
- **总指挥**: 5名用户 → 总指挥工作台
- **管理员**: 1名用户 → 管理员工作台
- **球磨工**: 3名用户 → 球磨车间记录
- **压滤工**: 9名用户 → 压滤车间记录
- **化验师**: 3名用户 → 生产控制中心
- **组长**: 1名用户 → 采购管理系统

### 系统优势
1. **数据驱动**: 重定向规则完全由数据库配置，无需修改代码
2. **灵活扩展**: 可随时添加新的工作页面和用户映射
3. **集中管理**: 所有映射关系在数据库中统一管理
4. **实时生效**: 数据库更改立即生效，无需重启应用

---

**文档版本**: v2.0
**最后更新**: 2025-06-29
**维护者**: FDX SMART WORK 2.0 开发团队
**更新内容**: 基于Supabase数据库实际配置更新重定向逻辑说明
