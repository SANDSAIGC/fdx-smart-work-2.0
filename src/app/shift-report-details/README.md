# 生产班报详情页面

## 页面概述
生产班报详情页面基于 `incoming-ore-details` 页面的成功架构模式创建，提供生产班报数据的全面分析和管理功能。

## 页面路由
- **路径**: `/shift-report-details`
- **文件位置**: `src/app/shift-report-details/page.tsx`
- **API路由**: `src/app/api/shift-report-details/route.ts`

## 页面架构

### Header组件
- 使用 `Header-2` 组件（带返回按钮的子页面样式）
- 页面标题: "生产班报详情"
- 副标题: 自动生成
- 图标: `TruckIcon` (h-5 w-5尺寸)

### 数据库连接
**主要数据表**:
- `生产班报-FDX` (富鼎翔生产班报数据)
- `生产班报-JDXY` (金鼎锌业生产班报数据)
- `生产班报-KL` (科力生产班报数据)

**核心数据字段**:
- 日期、班次
- 氧化锌原矿数据: 湿重、水份、干重、Pb全品位、Zn全品位、全金属Pb、全金属Zn
- 氧化锌精矿数据: 数量、Pb品位、Zn品位、Pb金属量、Zn金属量
- 尾矿数据: 数量、Pb全品位、Zn全品位、Pb全金属、Zn全金属
- 氧化矿Zn理论回收率

## 页面模块

### PART1: 生产趋势总览
**功能特性**:
- Carousel 轮播展示17个独立折线图
- 快捷日期选择按钮（最近七天、最近一月、最近半年）
- 自定义日期范围选择
- 右上角手动刷新按钮

**图表配置**:
- 17个 Line Chart - Multiple (三曲线对比：金鼎、富鼎翔、科力)
- 数据参数分组:
  - 回收率(1个): 氧化矿Zn理论回收率
  - 原矿数据(7个): 湿重、水份、干重、Pb全品位、Zn全品位、全金属Pb、全金属Zn
  - 精矿数据(5个): 数量、Pb品位、Zn品位、Pb金属量、Zn金属量
  - 尾矿数据(5个): 数量、Pb全品位、Zn全品位、Pb全金属、Zn全金属
- 聚合逻辑: 按日期聚合，t值汇总，%值加权平均

### PART2: 生产单日详情
**功能特性**:
- Tabs 组件分别显示金鼎数据、富鼎翔数据、科力数据
- 日期选择器 + 手动刷新按钮
- 使用柱状图组件展示数据（Bar Chart - Label）

**图表配置**:
- 4组柱状图，每组显示相关参数:
  - 回收率数据: 氧化矿Zn理论回收率
  - 原矿数据: 湿重、水份、干重、Pb全品位、Zn全品位、全金属Pb、全金属Zn
  - 精矿数据: 数量、Pb品位、Zn品位、Pb金属量、Zn金属量
  - 尾矿数据: 数量、Pb全品位、Zn全品位、Pb全金属、Zn全金属
- 标准文字: "按照金鼎锌业标准" / "按照富鼎翔标准" / "按照科力标准"

### PART3: 生产数据汇总
**功能特性**:
- 快捷日期选择按钮和自定义日期范围
- Tabs 组件分别显示金鼎数据、富鼎翔数据、科力数据
- 导出EXCEL功能（CSV格式）
- 右上角手动刷新按钮

**表格配置**:
- 显示核心字段: 日期、班次、原矿湿重、原矿水份、精矿数量、Zn回收率
- 分页显示: 每页10条记录
- 支持日期列排序功能（升序/降序）
- 数据缺失显示"--"
- 数据详情对话框（点击眼睛图标查看完整数据）

## 技术实现

### 数据处理逻辑
- **聚合计算**: 同日期多条数据时，重量值(t)直接汇总，百分比值(%)按重量加权平均
- **数据获取**: 使用 Supabase API 方法
- **错误处理**: 数据为null时显示默认值0

### 组件和样式规范
- **组件优先级**: 现有组件 > shadcn/ui组件 > 自定义组件
- **图标规范**: 使用 Lucide React 图标库，尺寸统一
- **响应式设计**: 
  - 柱状图: `grid grid-cols-1 lg:grid-cols-2 gap-4`
  - 支持明暗主题切换

### 状态管理
- `fdxData` / `jdxyData` / `klData`: 三个数据源的数据
- `trendStartDate` / `trendEndDate`: 趋势图日期范围
- `singleDate` / `singleDayTab`: 单日详情日期和选项卡
- `tableStartDate` / `tableEndDate` / `activeTab`: 表格日期范围和选项卡
- `currentPage` / `sortOrder`: 分页和排序状态

### 核心函数
- `fetchShiftReportData`: 数据获取（支持三个数据源）
- `processTrendData`: 趋势图数据处理和聚合
- `processSingleDayBarData`: 单日柱状图数据处理
- `processJdxyTableData` / `processFdxTableData` / `processKlTableData`: 表格数据处理
- `TrendChartComponent`: 趋势图组件（三曲线对比）
- `BarChartComponent`: 柱状图组件
- `DataDetailDialog`: 数据详情对话框组件
- `exportToExcel`: 导出EXCEL功能
- `toggleSort`: 排序切换

## 当前状态

### ✅ 已完成功能（100%）
- 基础页面架构和路由
- Header组件配置（标题：生产班样详情）
- API路由实现（支持三个数据源）
- 数据接口定义（完整TypeScript类型）
- PART1: 趋势图表轮播（17个折线图，三曲线对比）
- PART2: 单日详情柱状图功能（4组柱状图）
- PART3: 数据表格显示（三个选项卡）
- 数据聚合逻辑（t值汇总，%值加权平均）
- 分页功能（每页10条记录）
- 排序功能（日期列升序/降序）
- 导出EXCEL功能（CSV格式）
- 数据详情对话框（完整字段展示）
- 响应式布局和主题适配
- 性能优化（useCallback、useMemo）
- 错误处理和用户反馈

### 🎉 功能完成状态
- **PART1**: ✅ 完成（17个趋势图轮播）
- **PART2**: ✅ 完成（4组柱状图展示）
- **PART3**: ✅ 完成（表格、分页、排序、导出、详情）

## 验收标准
✅ 页面基础架构完成
✅ 趋势图表轮播功能完整实现
✅ 单日详情柱状图正常显示
✅ 数据正确连接到生产班报数据表
✅ 数据表格功能完整实现
✅ 分页和排序功能正常
✅ 导出EXCEL功能可用
✅ 数据详情对话框正常显示
✅ 响应式设计支持
✅ 无TypeScript编译错误
✅ 所有功能模块完成

## 功能特色

### 📊 数据表格功能
- **三数据源支持**: 金鼎、富鼎翔、科力数据独立显示
- **核心字段展示**: 日期、班次、原矿湿重、原矿水份、精矿数量、Zn回收率
- **智能分页**: 每页10条记录，支持前后翻页
- **排序功能**: 日期列支持升序/降序排序
- **数据详情**: 点击眼睛图标查看完整的20个字段数据
- **导出功能**: 支持导出为CSV格式的EXCEL文件

### 📈 柱状图分析
- **四组数据**: 回收率、原矿、精矿、尾矿数据分组展示
- **智能聚合**: 同日期多条数据自动聚合计算
- **响应式布局**: 2x2网格布局，移动端自适应
- **数据标签**: 柱状图顶部显示具体数值

### 🔄 数据处理
- **实时筛选**: 根据日期范围动态筛选数据
- **加权平均**: 百分比数据按重量进行加权平均计算
- **空值处理**: 数据缺失时显示"--"，避免计算错误

## 更新日志
- 2025-01-XX: 初始创建，基于 incoming-ore-details 架构
- 完成基础页面结构和单日详情功能
- 实现柱状图数据展示和聚合逻辑
- 添加三个数据源支持（金鼎、富鼎翔、科力）
- 完成数据表格功能：分页、排序、详情对话框
- 实现导出EXCEL功能和完整的数据处理逻辑
- **完成PART1趋势图表轮播**: 17个折线图，三曲线对比展示
- **项目100%完成**: 所有功能模块全部实现并测试通过
